#!/bin/bash

#Script should run as root.
[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

#Script should exit if any operation fails.
set -e

export title=$(sed '1q;d' "$HOME"/config.txt)
export collection=$(sed '2q;d' "$HOME"/config.txt)
export passphrase=$(sed '3q;d' "$HOME"/config.txt)

export CrystalID="$1"

printf "$passphrase" > "$CrystalID".tmp

tar -cv --format pax -f "$CrystalID".pax "$@"

xz -k -C sha256 -9 -e -v "$CrystalID".pax

rm -v ./"$CrystalID".pax

gpg --yes -c --cipher-algo AES256 --batch --passphrase-file "$CrystalID".tmp "$CrystalID".pax.xz

rm -v ./"$CrystalID".pax.xz

mv ./"$CrystalID".pax.xz.gpg ./"$CrystalID".coal5

ia upload "$CrystalID" --metadata="subject:Uploaded using Crystallise 2.0; 1EA21BD8-DB7E-11E5-9733-728C37852114; $title" --metadata="collection:$collection" --delete "$@"

echo "Uploaded to https://archive.org/download/$CrystalID"

#Delete everything except log
echo "Cleaning up..."
rm -rv "${@:2}"

#Upload log file and passphrase file
crystallise-logsession "$CrystalID" "$CrystalID".tmp 2>&1 /dev/null

echo "Done!"