#!/bin/bash

# Do not run this script manually; use crystallise instead.

#Script should run as root.
[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

#Script should exit if any operation fails.
set -e

echo "Arguments: " "$@"

echo "Configuration: "

cat "$HOME"/config.txt

crystalTitle=$(sed '1q;d' "$HOME"/config.txt)
export crystalTitle
crystalCollection=$(sed '2q;d' "$HOME"/config.txt)
export crystalCollection
crystallisePassphrase=$(sed '3q;d' "$HOME"/config.txt)
export crystallisePassphrase

export CrystalID="$1"

echo "Environment: "

uname -ap

echo "Environment variables: "

printenv

echo "The crystal will have the following address when it is ready: $CrystalID"

printf "%s" "$crystallisePassphrase" > ./"$CrystalID".tmp

echo "Building local index..."

hashdeep -c md5,sha1,sha256 -o fbcpsde "$@" $(pwd)/$CrystalID | tee ./"$CrystalID.local.idx"

echo "Building deep index..."

hashdeep -c md5,sha1,sha256 -o fbcpsde -r "$@" $(pwd)/$CrystalID | tee ./"$CrystalID.deep.idx"

tar -cv -P --format pax -f ./"$CrystalID".pax "$@" $(pwd)/$CrystalID ./"$CrystalID.local.idx" ./"$CrystalID.deep.idx" $(pwd)/"$CrystalID.local.idx" $(pwd)/"$CrystalID.deep.idx" ./"$CrystalID.tmp" $(pwd)/"$CrystalID.tmp"

script /dev/null xz -k -C sha256 -9 -e -v ./"$CrystalID".pax

rm -v ./"$CrystalID".pax

gpg --yes -c -v --cipher-algo AES256 --batch --passphrase-file "$CrystalID".tmp ./"$CrystalID".pax.xz

rm -v ./"$CrystalID".pax.xz

mv ./"$CrystalID".pax.xz.gpg ./"$CrystalID".coal5

echo "Computing checksum..."

hashdeep -c md5,sha1,sha256 -o fbcpsde ./"$CrystalID".coal5 | tee ./"$CrystalID.checksums"

echo "Sending..."

script /dev/null ia upload "$CrystalID" --retries=10 --metadata="subject:Uploaded using Crystallise $crystalliseVersion" --metadata="subject:1EA21BD8-DB7E-11E5-9733-728C37852114" --metadata="subject:$crystalTitle" --metadata="collection:$crystalCollection" --delete ./"$CrystalID".coal5

echo "Retrieving remote index..."

wget --save-headers --output-document - "https://archive.org/metadata/$CrystalID/" | tee ./"$CrystalID.json"

script /dev/null xz -C sha256 -9 -e -v ./"$CrystalID.json"

echo "Copying indices..."

rsync -av --progress --checksum ./"$CrystalID.local.idx" ./"$CrystalID.deep.idx" ./"$CrystalID.checksums" ./"$CrystalID.json.xz" /Ember\ Media\ Library/Futuramerlin\ Projects/Data/Crystal\ Index/

echo "Uploaded to https://archive.org/download/$CrystalID"

#Delete everything except log
echo "Cleaning up..."
rm -rv "${@:2}"

#Clear the screen
printf "\033c"

echo "Done sending! The new crystal's address is:"
echo "$CrystalID"