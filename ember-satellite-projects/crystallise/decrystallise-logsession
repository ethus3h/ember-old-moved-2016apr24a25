#!/bin/bash

# Do not run this script manually; use decrystallise instead.

#Script should run as root.
[ "$(whoami)" != "root" ] && exec sudo -- "$0" "$@"

#Script should exit if any operation fails.
set -e

echo "Arguments: " "$@"

crystallisePassphrase=$(sed '3q;d' "$HOME"/config.txt)
export crystallisePassphrase

export CrystalID="$1"

echo "Environment: "

uname -ap

echo "Environment variables: "

printenv

echo "Crystal address: $CrystalID"

printf "%s" "$crystallisePassphrase" > "./$CrystalLogID".tmp

echo "Receiving..."

wget -O "./$CrystalLogID".pax.xz.gpg "https://archive.org/download/$CrystalID/$CrystalID".coal5

gpg --yes --batch --passphrase-file "./$CrystalLogID".tmp "./$CrystalLogID".pax.xz.gpg

rm -v "./$CrystalLogID".pax.xz.gpg

unxz "./$CrystalLogID".pax.xz

mkdir -v ./"$CrystalLogID.tmpd"

tar -xvf "./$CrystalLogID".pax -C ./"$CrystalLogID.tmpd"/

rm -v "./$CrystalLogID".pax

rsync -av --checksum "./$CrystalLogID" "./$CrystalLogID".log

rm -v "./$CrystalLogID"

mv -v ./"$CrystalLogID.tmpd"/ ./"$CrystalLogID"

#Clear the screen
printf "\033c"

echo "Done receiving! The crystal has been extracted to:"
echo "$CrystalLogID"